<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>科普文章生成系统 - Tailwind版</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Mammoth.js 用于DOCX文件预览 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <!-- Configure Tailwind Theme to match original CSS variables -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1677ff',
            'primary-hover': '#0958d9',
            success: '#52c41a',
            'success-hover': '#389e0d',
            error: '#ff4d4f',
            'error-hover': '#cf1322',
            'text': '#333', // Use default text-gray-800 or customize further
            'light-text': '#666', // Use text-gray-500
            'border': '#eee', // Use border-gray-200
            'background': '#f5f7fa', // Use bg-gray-100
            'card-bg': '#fff', // Use bg-white
            'disabled-bg': '#f5f5f5', // Use bg-gray-100 or bg-gray-200
            'disabled-text': '#bbb', // Use text-gray-400
            'progress-bg': '#e6f4ff', // Use bg-blue-100
          },
          boxShadow: {
            'card': '0 4px 12px rgba(0, 0, 0, 0.08)', // Use shadow-md or shadow-lg
          },
          transitionProperty: {
            'default': 'all',
          },
          transitionDuration: {
            'default': '300ms',
          }
        }
      }
    }
  </script>
  <style>
    /* Add a specific style for the radio tile selected state if needed */
    .radio-tile.selected {
      border-color: #1677ff; /* Tailwind: border-primary */
      background-color: #e6f4ff; /* Tailwind: bg-progress-bg */
    }
    /* Custom radio button visual style */
     .radio-tile.selected .radio-icon::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 10px; /* Tailwind: w-2.5 */
      height: 10px; /* Tailwind: h-2.5 */
      background-color: white; /* Tailwind: bg-white */
      border-radius: 50%; /* Tailwind: rounded-full */
      transform: translate(-50%, -50%);
    }
    /* Base input styling (Tailwind applies focus styles automatically) */
    input, select, textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid #eee;
      border-radius: 0.375rem;
      font-size: 1rem;
      transition: all 0.3s;
      background-color: white;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #1677ff;
      box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.1);
    }
    
    /* 确保下拉菜单可用 */
    select {
      appearance: auto;
      padding-right: 2rem;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20' stroke='%23666'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
    }
  </style>
</head>
<body class="bg-background text-text font-sans antialiased min-h-screen">

  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-card-bg rounded-lg shadow-card p-8 w-11/12 max-w-md">
      <h2 class="text-center text-2xl font-medium mb-5">操作员登录</h2>
      <p class="text-sm text-light-text text-center mb-5">请输入您的账号，仅限英文和数字</p>
      <div id="loginError" class="bg-red-100 border border-red-200 text-error text-sm rounded p-3 mb-4 hidden"></div>
      <input type="text" id="loginUsername" placeholder="请输入账号" maxlength="20" class="mb-5">
      <button id="loginButton" class="w-full bg-primary hover:bg-primary-hover text-white font-medium py-3 rounded-md transition duration-default">登录</button>
    </div>
  </div>

  <!-- Logged in user display -->
  <div id="loggedInUser" class="absolute top-5 right-5 bg-card-bg rounded-full shadow-card px-4 py-2 text-sm flex items-center gap-3 hidden">
    操作员: <span id="username" class="font-medium"></span>
    <button id="logoutBtn" class="bg-error hover:bg-error-hover text-white text-xs font-medium px-2 py-1 rounded transition duration-default">切换</button>
  </div>

  <div class="max-w-7xl mx-auto px-4 py-5 lg:flex lg:gap-5">
    <!-- Main Content -->
    <div class="flex-1 lg:max-w-3xl">
      <header class="text-center mb-8">
        <h1 class="text-3xl font-bold mb-2">科普文章生成系统</h1>
      </header>

      <!-- Progress Steps -->
      <div class="relative flex justify-between mb-8">
        <!-- Connecting line -->
        <div class="absolute top-4 left-0 right-0 h-0.5 bg-border z-0"></div>
        <!-- Step 1 -->
        <div class="relative flex flex-col items-center z-10 step" id="step1">
          <div class="step-number w-8 h-8 rounded-full bg-border text-light-text flex items-center justify-center font-bold mb-2 transition duration-default">1</div>
          <div class="step-title text-sm text-light-text transition duration-default">输入基本信息</div>
        </div>
        <!-- Step 2 -->
        <div class="relative flex flex-col items-center z-10 step" id="step2">
          <div class="step-number w-8 h-8 rounded-full bg-border text-light-text flex items-center justify-center font-bold mb-2 transition duration-default">2</div>
          <div class="step-title text-sm text-light-text transition duration-default">选择文章标题</div>
        </div>
        <!-- Step 3 -->
        <div class="relative flex flex-col items-center z-10 step" id="step3">
          <div class="step-number w-8 h-8 rounded-full bg-border text-light-text flex items-center justify-center font-bold mb-2 transition duration-default">3</div>
          <div class="step-title text-sm text-light-text transition duration-default">生成文章</div>
        </div>
      </div>

      <!-- Container for Pages -->
      <div class="w-full">
        <!-- Page 1: Input Information -->
        <div class="bg-card-bg rounded-lg shadow-card p-6 mb-5 transition duration-default" id="page1">
          <h2 class="text-xl font-semibold mb-6">请输入您的基本信息</h2>
          <div class="mb-5">
            <label for="name" class="block font-medium mb-2">姓名</label>
            <input type="text" id="name" placeholder="请输入您的姓名" class="form-input">
          </div>
          <div class="mb-5">
            <label for="unit" class="block font-medium mb-2">科室</label>
            <input type="text" id="unit" placeholder="请输入您的科室" class="form-input">
          </div>
          <div class="mb-5">
            <label for="direction" class="block font-medium mb-2">方向</label>
            <input type="text" id="direction" placeholder="请输入文章方向或主题" class="form-input">
          </div>
          <div class="mb-5">
            <label for="word_count" class="block font-medium mb-2">字数</label>
            <input type="number" id="word_count" value="1500" min="100" max="5000" class="form-input">
          </div>
          <div class="mb-5">
            <label for="style" class="block font-medium mb-2">文章风格</label>
            <select id="style" class="form-select">
              <option value="生动有趣，角度新颖">生动有趣，角度新颖</option>
              <option value="通俗易懂，深入浅出">通俗易懂，深入浅出</option>
              <option value="幽默风趣，轻松活泼">幽默风趣，轻松活泼</option>
              <option value="严谨专业，循证可靠">严谨专业，循证可靠</option>
              <option value="亲切温暖，富有同理心">亲切温暖，富有同理心</option>
              <option value="故事化叙述，情景再现">故事化叙述，情景再现</option>
              <option value="生活化演绎，实用性强">生活化演绎，实用性强</option>
              <option value="custom">自定义风格</option>
            </select>
          </div>
          <div class="mb-5 mt-3 hidden" id="customStyleContainer">
            <label for="customStyle" class="block font-medium mb-2">自定义风格</label>
            <input type="text" id="customStyle" placeholder="请输入自定义风格描述">
          </div>
          <div class="mt-6">
            <button id="nextToTitles" class="w-full bg-primary hover:bg-primary-hover text-white font-medium py-3 px-6 rounded-md transition duration-default disabled:bg-disabled-bg disabled:text-disabled-text disabled:cursor-not-allowed">下一步</button>
          </div>
        </div>

        <!-- Page 2: Select Title -->
        <div class="bg-card-bg rounded-lg shadow-card p-6 mb-5 transition duration-default hidden" id="page2">
          <h2 class="text-xl font-semibold mb-6">请选择文章标题</h2>
          <!-- Title Generation Progress -->
          <div class="mt-4 mb-6" id="titleProgressContainer">
            <div class="flex justify-between mb-2">
              <div class="text-sm text-light-text">正在生成标题...</div>
              <div class="text-sm text-light-text" id="titleProgressPercentage">0%</div>
            </div>
            <div class="w-full h-2.5 bg-progress-bg rounded-full overflow-hidden">
              <div id="titleProgressFill" class="h-full bg-primary rounded-full transition-width duration-500 ease-linear" style="width: 0%;"></div>
            </div>
          </div>
          
          <!-- Title Selection Area -->
          <div id="titleSelectionContainer" class="hidden">
            <div class="flex flex-col gap-4 mb-5" id="titleOptions">
              <!-- Title options will be inserted here -->
            </div>
            
            <!-- Custom Title Option -->
            <div class="border-2 border-border rounded-md p-4 cursor-pointer transition duration-default relative radio-tile" id="customTitleTile">
              <div class="font-medium mb-1">自定义标题</div>
              <div class="absolute top-4 right-4 w-5 h-5 border-2 border-gray-300 rounded-full transition duration-default radio-icon"></div>
              <input type="radio" name="title" value="custom" class="absolute opacity-0 w-0 h-0">
            </div>
            
            <!-- Custom Title Input Area -->
            <div class="mt-4 hidden" id="customTitleContainer">
              <div class="mb-5">
                <input type="text" id="customTitle" placeholder="请输入您的标题">
              </div>
            </div>
            
            <!-- Buttons -->
            <div class="flex flex-col sm:flex-row justify-between gap-4 mt-6">
              <button id="backToInfo" class="flex-1 bg-gray-200 hover:bg-gray-300 text-light-text font-medium py-3 px-6 rounded-md transition duration-default">上一步</button>
              <button id="regenerateTitles" class="flex-1 bg-gray-200 hover:bg-gray-300 text-light-text font-medium py-3 px-6 rounded-md transition duration-default">重新生成标题</button>
              <button id="nextToGenerate" class="flex-1 bg-primary hover:bg-primary-hover text-white font-medium py-3 px-6 rounded-md transition duration-default disabled:bg-disabled-bg disabled:text-disabled-text disabled:cursor-not-allowed">开始生成文章</button>
            </div>
          </div>
        </div>

        <!-- Page 3: Generate Article -->
        <div class="bg-card-bg rounded-lg shadow-card p-6 mb-5 transition duration-default hidden" id="page3">
          <h2 class="text-xl font-semibold mb-6">文章生成</h2>
          <!-- Article Generation Progress -->
          <div class="mt-4 mb-6" id="articleProgressContainer">
            <div class="flex justify-between mb-2">
              <div class="text-sm text-light-text">正在生成文章...</div>
              <div class="text-sm text-light-text" id="articleProgressPercentage">0%</div>
            </div>
            <div class="w-full h-2.5 bg-progress-bg rounded-full overflow-hidden">
              <div id="articleProgressFill" class="h-full bg-primary rounded-full transition-width duration-500 ease-linear" style="width: 0%;"></div>
            </div>
          </div>
          
          <!-- Article Result -->
          <div id="articleResultContainer" class="hidden text-center p-8">
            <div class="text-5xl text-success mb-5">✓</div>
            <h3 class="text-xl font-semibold mb-3">文章生成成功！</h3>
            <p class="text-light-text mb-5">点击下方按钮下载文章</p>
            <a href="#" id="downloadArticle" target="_blank" class="inline-flex items-center gap-2 bg-progress-bg hover:bg-blue-200 text-primary font-medium py-3 px-6 rounded-md transition duration-default mb-6">
              <i>📄</i> 下载文章 (DOCX)
            </a>
            <div class="flex flex-col sm:flex-row justify-between gap-4 mt-6">
               <button id="backToTitles" class="flex-1 bg-gray-200 hover:bg-gray-300 text-light-text font-medium py-3 px-6 rounded-md transition duration-default">返回选择标题</button>
              <button id="regenerateArticle" class="flex-1 bg-primary hover:bg-primary-hover text-white font-medium py-3 px-6 rounded-md transition duration-default">重新生成文章</button>
            </div>
          </div>
        </div>

        <!-- Error message container -->
        <div id="errorContainer" class="bg-red-100 border border-error text-error text-sm rounded p-4 mb-5 hidden"></div>
      </div>
    </div>

    <!-- History Panel -->
    <div class="lg:w-80 lg:ml-5 mt-5 lg:mt-0">
      <div class="bg-card-bg rounded-lg shadow-card p-6">
        <h2 class="text-lg font-semibold pb-3 mb-4 border-b border-border">历史文章</h2>
        <div id="historyLoadingContainer" class="text-center py-5 text-light-text">
          <p>加载历史文章...</p>
        </div>
        <div id="historyList" class="space-y-3 max-h-[600px] overflow-y-auto">
          <!-- History items will be inserted here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Preview Modal -->
  <div id="previewModal" class="fixed inset-0 z-40 items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-4xl max-h-[90vh] p-5 flex flex-col">
      <div class="flex justify-between items-center pb-3 mb-4 border-b border-border">
        <h3 id="previewTitle" class="text-lg font-medium">文章预览</h3>
        <button id="closeModal" class="text-light-text hover:text-text text-2xl">&times;</button>
      </div>
      <div class="flex-1 overflow-hidden">
        <div id="previewFallback" class="hidden w-full h-[500px] border border-border rounded flex flex-col items-center justify-center p-8 text-center">
          <div class="text-4xl mb-4">📄</div>
          <h4 class="text-xl font-medium mb-2">正在加载文档...</h4>
          <p class="text-light-text mb-6 docx-loading">正在将Word文档转换为网页格式，请稍候...</p>
          <div class="docx-error hidden">
            <p class="text-error mb-6">文档加载失败，此格式可能不支持在线预览</p>
            <p class="text-sm text-light-text mb-6">请点击下方按钮下载查看</p>
          </div>
        </div>
        <div id="docxPreview" class="hidden w-full h-[500px] border border-border rounded p-4 overflow-auto">
          <!-- 这里将显示转换后的DOCX内容 -->
        </div>
        <iframe id="previewFrame" class="w-full h-[500px] border border-border rounded" src=""></iframe>
      </div>
      <div class="flex justify-end pt-4 mt-4 border-t border-border">
        <a href="#" id="downloadPreview" target="_blank" class="bg-primary hover:bg-primary-hover text-white font-medium py-2 px-5 rounded-md transition duration-default">下载文章</a>
      </div>
    </div>
  </div>

  <script>
    // DOM Elements (IDs remain the same)
    const page1 = document.getElementById('page1');
    const page2 = document.getElementById('page2');
    const page3 = document.getElementById('page3');
    
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    
    const nextToTitlesBtn = document.getElementById('nextToTitles');
    const backToInfoBtn = document.getElementById('backToInfo');
    const nextToGenerateBtn = document.getElementById('nextToGenerate');
    const backToTitlesBtn = document.getElementById('backToTitles');
    const regenerateArticleBtn = document.getElementById('regenerateArticle');
    const regenerateTitlesBtn = document.getElementById('regenerateTitles');
    
    const nameInput = document.getElementById('name');
    const unitInput = document.getElementById('unit');
    const directionInput = document.getElementById('direction');
    const wordCountInput = document.getElementById('word_count');
    
    const styleSelect = document.getElementById('style');
    const customStyleContainer = document.getElementById('customStyleContainer');
    const customStyleInput = document.getElementById('customStyle');
    
    const titleProgressContainer = document.getElementById('titleProgressContainer');
    const titleProgressFill = document.getElementById('titleProgressFill');
    const titleProgressPercentage = document.getElementById('titleProgressPercentage');
    const titleSelectionContainer = document.getElementById('titleSelectionContainer');
    const titleOptions = document.getElementById('titleOptions');
    
    const customTitleTile = document.getElementById('customTitleTile');
    const customTitleContainer = document.getElementById('customTitleContainer');
    const customTitleInput = document.getElementById('customTitle');
    
    const articleProgressContainer = document.getElementById('articleProgressContainer');
    const articleProgressFill = document.getElementById('articleProgressFill');
    const articleProgressPercentage = document.getElementById('articleProgressPercentage');
    const articleResultContainer = document.getElementById('articleResultContainer');
    const downloadArticleLink = document.getElementById('downloadArticle');
    
    const errorContainer = document.getElementById('errorContainer');
    
    // History Elements
    const historyList = document.getElementById('historyList');
    const historyLoadingContainer = document.getElementById('historyLoadingContainer');
    
    // Modal Elements
    const previewModal = document.getElementById('previewModal');
    const closeModal = document.getElementById('closeModal');
    const previewFrame = document.getElementById('previewFrame');
    const previewTitle = document.getElementById('previewTitle');
    const downloadPreview = document.getElementById('downloadPreview');
    const previewFallback = document.getElementById('previewFallback');
    const docxPreview = document.getElementById('docxPreview');
    
    // Login Elements
    const loginModal = document.getElementById('loginModal');
    const loginUsername = document.getElementById('loginUsername');
    const loginButton = document.getElementById('loginButton');
    const loginError = document.getElementById('loginError');
    const loggedInUser = document.getElementById('loggedInUser');
    const usernameSpan = document.getElementById('username');
    const logoutBtn = document.getElementById('logoutBtn');
    
    // State management (remains the same)
    let selectedTitle = '';
    let generatedTitles = [];
    let articleUrl = '';
    let userInfo = {
      openid: '',
      name: '',
      unit: '',
      direction: '',
      word_count: 1500,
      style: '生动有趣，角度新颖'
    };
    let historyArticles = [];
    
    // --- Initialization and Login Logic (largely unchanged, adjusted for Tailwind classes) ---
    document.addEventListener('DOMContentLoaded', function() {
      checkLogin();
      setupEventListeners(); // Setup event listeners after DOM is ready
    });

    function checkLogin() {
      const savedUsername = localStorage.getItem('articleGenerator_username');
      if (savedUsername) {
        completeLogin(savedUsername);
      } else {
        loginModal.classList.remove('hidden');
        loginModal.classList.add('flex'); // Use flex for centering
      }
    }

    function handleLogin() {
      loginError.classList.add('hidden');
      const username = loginUsername.value.trim();
      if (!username) {
        showLoginError('请输入账号'); return;
      }
      if (!/^[a-zA-Z0-9]+$/.test(username)) {
        showLoginError('账号只能包含英文字母和数字'); return;
      }
      localStorage.setItem('articleGenerator_username', username);
      completeLogin(username);
    }

    function completeLogin(username) {
      loginModal.classList.add('hidden');
      loginModal.classList.remove('flex');
      userInfo.openid = 'internal_' + username;
      usernameSpan.textContent = username;
      loggedInUser.classList.remove('hidden');
      loadArticleHistory();
    }

    function showLoginError(message) {
      loginError.textContent = message;
      loginError.classList.remove('hidden');
    }

    function handleLogout() {
      localStorage.removeItem('articleGenerator_username');
      userInfo.openid = '';
      loggedInUser.classList.add('hidden');
      loginModal.classList.remove('hidden');
      loginModal.classList.add('flex');
      loginUsername.value = '';
      // Maybe reset to step 1?
      goToInfoPage(); 
      historyList.innerHTML = ''; // Clear history on logout
      historyLoadingContainer.style.display = 'none'; // Hide loading indicator
      generatedTitles = []; // Clear generated titles state
      selectedTitle = ''; // Clear selected title state
    }
    
    // --- Event Listeners Setup ---
    function setupEventListeners() {
      loginButton.addEventListener('click', handleLogin);
      logoutBtn.addEventListener('click', handleLogout);
      loginUsername.addEventListener('keypress', function(event) {
        if (event.key === 'Enter') handleLogin();
      });

      nextToTitlesBtn.addEventListener('click', goToTitlesPage);
      backToInfoBtn.addEventListener('click', goToInfoPage);
      nextToGenerateBtn.addEventListener('click', goToGeneratePage);
      backToTitlesBtn.addEventListener('click', () => goToTitlesPage(true)); // Pass flag to indicate returning
      regenerateArticleBtn.addEventListener('click', generateArticle);
      regenerateTitlesBtn.addEventListener('click', () => {
        selectedTitle = '';
        generatedTitles = [];
        generateTitles();
      });

      customTitleTile.addEventListener('click', () => {
          // Find the hidden radio input inside and check it
          const radio = customTitleTile.querySelector('input[type="radio"]');
          if (radio) radio.checked = true; 
          selectTitle('custom'); // Call the existing select function
          customTitleContainer.classList.remove('hidden');
      });


      styleSelect.addEventListener('change', function() {
        if (this.value === 'custom') {
          customStyleContainer.classList.remove('hidden');
        } else {
          customStyleContainer.classList.add('hidden');
        }
      });

      closeModal.addEventListener('click', () => {
        previewModal.classList.add('hidden');
        previewModal.classList.remove('flex'); // Remove flex display
        resetPreview(); // 重置预览状态
      });
      window.addEventListener('click', (event) => {
        if (event.target === previewModal) {
          previewModal.classList.add('hidden');
          previewModal.classList.remove('flex');
          resetPreview(); // 重置预览状态
        }
      });
    }

    // --- Page Navigation & Step Updates (adjusted for Tailwind classes) ---
    function hideAllPages() {
        page1.classList.add('hidden');
        page2.classList.add('hidden');
        page3.classList.add('hidden');
    }

    function updateSteps(currentStep) {
        const steps = [step1, step2, step3];
        steps.forEach((step, index) => {
            const numberEl = step.querySelector('.step-number');
            const titleEl = step.querySelector('.step-title');
            
            // Reset styles
            numberEl.classList.remove('bg-primary', 'text-white', 'bg-success');
            numberEl.classList.add('bg-border', 'text-light-text');
            titleEl.classList.remove('text-primary', 'font-medium', 'text-success');
            titleEl.classList.add('text-light-text');
            
            if (index + 1 < currentStep) { // Completed step
                numberEl.classList.remove('bg-border', 'text-light-text');
                numberEl.classList.add('bg-success', 'text-white');
                titleEl.classList.remove('text-light-text');
                // titleEl.classList.add('text-success'); // Optional: make completed title green
            } else if (index + 1 === currentStep) { // Active step
                numberEl.classList.remove('bg-border', 'text-light-text');
                numberEl.classList.add('bg-primary', 'text-white');
                titleEl.classList.remove('text-light-text');
                titleEl.classList.add('text-primary', 'font-medium');
            }
        });
    }

    function goToInfoPage() {
      hideAllPages();
      page1.classList.remove('hidden');
      updateSteps(1);
    }

    function goToTitlesPage(isReturning = false) {
      if (!validateInfoPage()) {
        return; // 验证未通过
      }
      
      console.log("验证通过，准备保存用户信息");
      
      // 检查必要的DOM元素是否存在
      if (!nameInput || !unitInput || !directionInput || !wordCountInput || !styleSelect) {
        console.error("表单元素未找到", {
          nameInput, unitInput, directionInput, wordCountInput, styleSelect
        });
        showError("表单加载出错，请刷新页面重试");
        return;
      }
      
      // 处理文章风格
      let style = "";
      if (styleSelect) {
        if (styleSelect.value === 'custom' && customStyleInput) {
          // 如果选择自定义风格，获取自定义风格输入
          const customStyle = customStyleInput.value.trim();
          if (!customStyle) {
            showError("请输入自定义风格描述");
            customStyleInput.focus();
            return;
          }
          style = customStyle;
        } else {
          // 使用选择的预设风格
          style = styleSelect.value;
        }
      } else {
        // 默认风格
        style = "生动有趣，角度新颖";
      }
      
      // 保存用户信息
      userInfo = {
        openid: userInfo ? userInfo.openid : '',
        name: nameInput ? nameInput.value.trim() : '',
        unit: unitInput ? unitInput.value.trim() : '',
        direction: directionInput ? directionInput.value.trim() : '',
        word_count: wordCountInput ? parseInt(wordCountInput.value) : 1500,
        style: style
      };
      
      console.log("已保存用户信息:", userInfo);
      
      // 先切换页面
      hideAllPages();
      page2.classList.remove('hidden');
      updateSteps(2);
      
      // 检查是否返回用户或已有标题
      if (isReturning && titleOptions && titleOptions.length > 0) {
        // 显示上次生成的标题
        displayTitleOptions(titleOptions);
      } else {
        // 生成新标题
        generateTitles();
      }
    }


    function goToGeneratePage() {
      if (!validateTitleSelection()) return;
      hideAllPages();
      page3.classList.remove('hidden');
      updateSteps(3);
      generateArticle();
    }

    // --- Validation Functions (adjusted for Tailwind errors) ---
    function validateInfoPage() {
      console.log("验证信息页...");
      
      // 获取输入值前先检查DOM元素是否存在
      if (!nameInput || !unitInput || !directionInput || !wordCountInput) {
        console.error("表单元素未找到", {
          nameInput, unitInput, directionInput, wordCountInput
        });
        showError("表单加载出错，请刷新页面重试");
        return false;
      }
      
      // 获取并去除空格
      const name = nameInput.value ? nameInput.value.trim() : "";
      const unit = unitInput.value ? unitInput.value.trim() : "";
      const direction = directionInput.value ? directionInput.value.trim() : "";
      const wordCount = parseInt(wordCountInput.value) || 0;
      
      console.log("表单值:", { name, unit, direction, wordCount });
      
      // 检查必填项
      if (!name) {
        showError("请输入您的姓名");
        nameInput.focus();
        return false;
      }
      
      if (!unit) {
        showError("请输入您的科室");
        unitInput.focus();
        return false;
      }
      
      if (!direction) {
        showError("请输入文章方向或主题");
        directionInput.focus();
        return false;
      }
      
      // 验证字数范围
      if (wordCount < 100 || wordCount > 5000) {
        showError("字数必须在100-5000之间");
        wordCountInput.focus();
        return false;
      }
      
      // 验证通过
      console.log("表单验证通过");
      return true;
    }

    function validateTitleSelection() {
      hideError();
      const selectedRadio = titleOptions.querySelector('input[name="title"]:checked');
      const customRadio = customTitleTile.querySelector('input[name="title"]'); // Get the custom radio itself
      
      if (customRadio && customRadio.checked) { // Check if custom radio is checked
        if (!customTitleInput.value.trim()) {
          showError('请输入自定义标题');
          customTitleInput.focus();
          return false;
        }
         selectedTitle = 'custom'; // Ensure selectedTitle state is correct
      } else if (!selectedRadio) { // Check if any other radio is selected
          showError('请选择一个标题');
          return false;
      } else {
          selectedTitle = selectedRadio.value; // Update selectedTitle state
      }
      
      // Disable next button if no title is selected implicitly (shouldn't happen with validation, but good practice)
      nextToGenerateBtn.disabled = !selectedTitle; 
      
      return true;
    }


    // --- API Functions (largely unchanged, ensure progress updates work) ---
     async function generateTitles() {
        try {
            titleOptions.innerHTML = '';
            titleSelectionContainer.classList.add('hidden');
            titleProgressContainer.classList.remove('hidden');
            updateTitleProgress(0);
            hideError();
            nextToGenerateBtn.disabled = true;
            regenerateTitlesBtn.disabled = true;
            
            // 确保数据完整性
            const payload = {
                openid: userInfo.openid || 'anonymous',
                direction: userInfo.direction || '健康科普',
                word_count: userInfo.word_count || 1500,
                name: userInfo.name || '未知用户',
                unit: userInfo.unit || '未知科室'
            };
            
            console.log('生成标题请求数据:', JSON.stringify(payload));
            
            const response = await fetch('/api/generate_titles', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            // Process SSE
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                const text = decoder.decode(value, { stream: true });
                const events = text.split('\n\n').filter(event => event.trim().startsWith('data:'));
                for (const event of events) {
                    try {
                        const eventData = JSON.parse(event.replace('data:', '').trim());
                        if (eventData.data && eventData.data.progress) {
                            updateTitleProgress(parseInt(eventData.data.progress));
                        }
                        if (eventData.event === 'workflow_finished') {
                            if (eventData.data && eventData.data.result && Array.isArray(eventData.data.result)) {
                                generatedTitles = eventData.data.result;
                                displayTitleOptions(generatedTitles);
                                titleSelectionContainer.classList.remove('hidden'); // Show results
                                titleProgressContainer.classList.add('hidden'); // Hide progress
                            } else {
                                throw new Error(eventData.data?.error || '生成标题失败，未收到有效结果');
                            }
                        }
                    } catch (e) { console.error('Error parsing title event data:', e); }
                }
            }
        } catch (error) {
            console.error('Error generating titles:', error);
            showError(`生成标题时出错: ${error.message}`);
            titleProgressContainer.classList.add('hidden'); // Hide progress on error
            // Optionally show the selection container so user can input custom title
            titleSelectionContainer.classList.remove('hidden');
            // Ensure custom title tile is reset visually if needed
             const customRadio = customTitleTile.querySelector('input[type="radio"]');
             if (customRadio) customRadio.checked = false;
             customTitleTile.classList.remove('selected', 'border-primary', 'bg-progress-bg');
             customTitleTile.classList.add('border-border');
             customTitleContainer.classList.add('hidden');

        } finally {
             regenerateTitlesBtn.disabled = false; // Re-enable regenerate button
             // nextToGenerate button will be enabled when a title is selected
        }
    }


    async function generateArticle() {
      try {
        // Reset UI
        articleResultContainer.classList.add('hidden');
        articleProgressContainer.classList.remove('hidden');
        updateArticleProgress(0);
        hideError();
        regenerateArticleBtn.disabled = true; // Disable button while generating

        // 检查用户信息和标题
        if (!userInfo) {
          console.error("用户信息未初始化");
          showError("用户信息未初始化，请刷新页面重试");
          articleProgressContainer.classList.add('hidden');
          return;
        }

        // Get the final title (ensure validation ran before calling this)
        const finalTitle = selectedTitle === 'custom' ? 
          (customTitleInput && customTitleInput.value ? customTitleInput.value.trim() : '默认标题') : 
          (selectedTitle || '默认标题');

        // 确保所有必要的字段都有默认值
        const payload = {
          openid: userInfo.openid || 'anonymous',
          direction: userInfo.direction || '健康科普',
          title: finalTitle,
          word_count: userInfo.word_count || 1500,
          name: userInfo.name || '未知用户',
          unit: userInfo.unit || '未知科室',
          style: userInfo.style || '生动有趣，角度新颖'
        };
        console.log('生成文章请求数据:', payload);

        const response = await fetch('/api/generate_article', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        // Process SSE
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          const text = decoder.decode(value, { stream: true });
          const events = text.split('\n\n').filter(event => event.trim().startsWith('data:'));
          for (const event of events) {
            try {
              const eventData = JSON.parse(event.replace('data:', '').trim());
              if (eventData.data && eventData.data.progress) {
                updateArticleProgress(parseInt(eventData.data.progress));
              }
              if (eventData.event === 'workflow_finished') {
                if (eventData.data && eventData.data.files && eventData.data.files.length > 0 && eventData.data.files[0].url) {
                  articleUrl = eventData.data.files[0].url;
                  showArticleResult(articleUrl);
                   setTimeout(() => loadArticleHistory(), 1000); // Reload history slightly faster
                } else {
                    throw new Error(eventData.data?.error || '生成文章失败，未收到文件URL');
                }
              }
            } catch (e) { console.error('Error parsing article event data:', e); }
          }
        }

      } catch (error) {
        console.error('Error generating article:', error);
        showError(`生成文章时出错: ${error.message}`);
        articleProgressContainer.classList.add('hidden'); // Hide progress on error
      } finally {
          regenerateArticleBtn.disabled = false; // Re-enable button
      }
    }

    // --- UI Update Functions (adjusted for Tailwind) ---
    function updateTitleProgress(progress) {
      titleProgressFill.style.width = `${progress}%`;
      titleProgressPercentage.textContent = `${progress}%`;
    }

    function updateArticleProgress(progress) {
      articleProgressFill.style.width = `${progress}%`;
      articleProgressPercentage.textContent = `${progress}%`;
    }

    function displayTitleOptions(titles) {
        selectedTitle = ''; // Reset selection when displaying new titles
        titleOptions.innerHTML = ''; // Clear existing options

        titles.forEach((title) => {
            const tile = document.createElement('div');
            // Base classes for the tile
            tile.className = 'border-2 border-border rounded-md p-4 cursor-pointer transition duration-default relative radio-tile hover:border-gray-400'; 
            tile.dataset.value = title;

            const titleElement = document.createElement('div');
            titleElement.className = 'font-medium mb-1'; // Style for the title text
            titleElement.textContent = title;

            const radioIcon = document.createElement('div');
            // Style for the custom radio icon
            radioIcon.className = 'absolute top-4 right-4 w-5 h-5 border-2 border-gray-300 rounded-full transition duration-default radio-icon';

            const radioInput = document.createElement('input');
            radioInput.type = 'radio';
            radioInput.name = 'title'; // Group radios
            radioInput.value = title;
            radioInput.className = 'absolute opacity-0 w-0 h-0'; // Hide the actual radio button

            tile.appendChild(titleElement);
            tile.appendChild(radioIcon);
            tile.appendChild(radioInput);

            // Add click listener to the tile itself
            tile.addEventListener('click', function() {
                radioInput.checked = true; // Check the hidden radio when tile is clicked
                selectTitle(title); // Call the select function
                customTitleContainer.classList.add('hidden'); // Hide custom input if showing
            });

            titleOptions.appendChild(tile);
        });
        
        // Reset custom title tile state
        customTitleTile.classList.remove('selected', 'border-primary', 'bg-progress-bg');
        customTitleTile.classList.add('border-border');
        const customRadio = customTitleTile.querySelector('input[type="radio"]');
        if(customRadio) customRadio.checked = false;
        customTitleContainer.classList.add('hidden');
        
        nextToGenerateBtn.disabled = true; // Disable next button until a selection is made
    }

    function selectTitle(titleValue) {
        selectedTitle = titleValue; // Update state

        // Update visual selection for all radio tiles
        document.querySelectorAll('.radio-tile').forEach(tile => {
            const radio = tile.querySelector('input[type="radio"]');
            if (radio && radio.value === titleValue) {
                 tile.classList.add('selected', 'border-primary', 'bg-progress-bg'); // Use style rule for selected
                 tile.classList.remove('border-border');
            } else {
                 tile.classList.remove('selected', 'border-primary', 'bg-progress-bg');
                 tile.classList.add('border-border');
            }
        });
        
        // Ensure custom title tile has correct styling if selected
        if (titleValue === 'custom') {
            customTitleTile.classList.add('selected', 'border-primary', 'bg-progress-bg');
             customTitleTile.classList.remove('border-border');
        } else {
            customTitleTile.classList.remove('selected', 'border-primary', 'bg-progress-bg');
             customTitleTile.classList.add('border-border');
        }

        nextToGenerateBtn.disabled = false; // Enable the next button now that a selection is made
    }


    function showArticleResult(url) {
      downloadArticleLink.href = url;
      articleResultContainer.classList.remove('hidden');
      articleProgressContainer.classList.add('hidden');
    }

    function showError(message) {
      errorContainer.textContent = message;
      errorContainer.classList.remove('hidden');
      // Scroll to error message for visibility
      errorContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function hideError() {
      errorContainer.textContent = '';
      errorContainer.classList.add('hidden');
    }

    // --- History Functions (adjusted for Tailwind) ---
    async function loadArticleHistory() {
      try {
        if (!historyList || !historyLoadingContainer) {
          console.error("历史列表DOM元素未找到");
          return; // 如果DOM元素不存在则退出
        }

        historyList.innerHTML = ''; // Clear previous
        historyLoadingContainer.style.display = 'block'; // Show loading
        
        const userId = userInfo && userInfo.openid;
        if (!userId) {
            console.log("User not logged in, skipping history load.");
            historyLoadingContainer.style.display = 'none';
            historyList.innerHTML = '<p class="text-sm text-light-text text-center">请先登录查看历史记录</p>';
            return;
        }

        try {
          // Define the JWT token - In a real app, this should be dynamically obtained after login
          const jwtToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiJzeXN0ZW0t5ZCO56uvIiwicm9sZSI6InN5c3RlbSIsInBlcm1pc3Npb25zIjpbInF1b3RhOnJlYWQiLCJxdW90YTp3cml0ZSIsImFydGljbGU6cmVhZCIsImFydGljbGU6d3JpdGUiLCJhcnRpY2xlOmRlbGV0ZSJdLCJpYXQiOjE3NDQyNDg3NDEsImV4cCI6MTc0Njg0MDc0MX0.aKnFmck6xwt4MMbegrLsssF7hZaZSrHbsgrjB24XJys'; 

          const response = await fetch(`/api/articles?user_id=${encodeURIComponent(userId)}`, {
            method: 'GET',
            headers: { 
              'Accept': '*/*', // Adjusted based on previous successful calls
              'Authorization': `Bearer ${jwtToken}` 
            }
          });

          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          const data = await response.json();
          historyArticles = data.records || [];
          
          if (historyLoadingContainer) {
            historyLoadingContainer.style.display = 'none'; // Hide loading
          }
          
          if (historyList) {
            displayArticleHistory(historyArticles);
          }
        } catch (fetchError) {
          console.error('Error loading article history:', fetchError);
          if (historyLoadingContainer) {
            historyLoadingContainer.style.display = 'none';
          }
          if (historyList) {
            historyList.innerHTML = `<div class="bg-red-100 border border-error text-error text-sm rounded p-3">加载历史文章失败: ${fetchError.message}</div>`;
          }
        }
      } catch (error) {
        console.error('Unexpected error in loadArticleHistory:', error);
      }
    }

    function displayArticleHistory(articles) {
      if (!historyList) {
        console.error("历史列表DOM元素未找到");
        return;
      }
      
      historyList.innerHTML = ''; // Clear current list
      
      if (!articles || articles.length === 0) {
        historyList.innerHTML = '<p class="text-sm text-light-text text-center">暂无历史文章</p>';
        return;
      }

      articles.forEach(article => {
        if (!article) return; // 跳过无效条目
        
        const item = document.createElement('div');
        // Tailwind classes for history item
        item.className = 'p-3 border border-border hover:border-primary rounded-md cursor-pointer transition duration-default hover:bg-progress-bg';
        item.dataset.id = article.id || '';
        item.dataset.url = article.public_url || '';

        const title = document.createElement('div');
        title.className = 'font-medium mb-1 break-words text-sm'; // Tailwind classes for title
        title.textContent = article.title || '无标题';

        const info = document.createElement('div');
        info.className = 'flex justify-between text-xs text-light-text'; // Tailwind classes for info line

        const author = document.createElement('span');
        author.textContent = article.author_name || '未知作者';

        const wordCount = document.createElement('span');
        wordCount.textContent = `${article.word_count || '?'} 字`;

        info.appendChild(author);
        info.appendChild(wordCount);

        const date = document.createElement('div');
        date.className = 'text-xs text-light-text mt-1'; // Tailwind classes for date
        date.textContent = formatDate(article.created_at);
        
        item.appendChild(title);
        item.appendChild(info);

        // Add style info if present
        if (article.style) {
            const styleDiv = document.createElement('div');
            styleDiv.className = 'text-xs text-primary italic mt-1'; // Style for the article style text
            styleDiv.textContent = `风格: ${article.style}`;
            item.appendChild(styleDiv);
        }

        item.appendChild(date);

        item.addEventListener('click', () => openPreview(article));
        historyList.appendChild(item);
      });
    }

    function formatDate(dateStr) {
      if (!dateStr) return '未知日期';
      try {
          const date = new Date(dateStr);
          return date.toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
      } catch (e) {
          return '日期无效';
      }
    }

    function openPreview(article) {
      if (!article) {
        console.error("无效的文章数据");
        return;
      }
      
      if (!previewTitle || !previewFrame || !downloadPreview || !previewModal || !previewFallback || !docxPreview) {
        console.error("预览窗口DOM元素未找到");
        return;
      }
      
      previewTitle.textContent = article.title || '无标题';
      if (article.style) {
        previewTitle.textContent += ` (${article.style})`;
      }
      
      const url = article.public_url || '';
      downloadPreview.href = url;
      
      // 显示预览模态框
      previewModal.classList.remove('hidden');
      previewModal.classList.add('flex'); // Use flex for centering
      
      // 检查文件类型，决定使用哪种预览方式
      if (url.toLowerCase().endsWith('.docx')) {
        // 使用 mammoth.js 处理 DOCX 文件
        handleDocxPreview(url);
      } else if (url.toLowerCase().endsWith('.doc') || 
                url.toLowerCase().endsWith('.xlsx') || 
                url.toLowerCase().endsWith('.pptx')) {
        // 其他不支持直接预览的格式，显示提示信息
        previewFrame.classList.add('hidden');
        docxPreview.classList.add('hidden');
        previewFallback.classList.remove('hidden');
        
        // 显示正确的提示信息
        const loadingEl = previewFallback.querySelector('.docx-loading');
        const errorEl = previewFallback.querySelector('.docx-error');
        if (loadingEl) loadingEl.classList.add('hidden');
        if (errorEl) errorEl.classList.remove('hidden');
        
        // 更新标题
        const titleEl = previewFallback.querySelector('h4');
        if (titleEl) titleEl.textContent = '此文件格式不支持直接预览';
      } else {
        // 尝试在iframe中加载其他格式（如PDF）
        previewFrame.src = url;
        previewFrame.classList.remove('hidden');
        docxPreview.classList.add('hidden');
        previewFallback.classList.add('hidden');
      }
    }
    
    async function handleDocxPreview(url) {
      try {
        // 隐藏iframe，显示加载状态
        previewFrame.classList.add('hidden');
        docxPreview.classList.add('hidden');
        previewFallback.classList.remove('hidden');
        
        // 显示正确的提示信息
        const loadingEl = previewFallback.querySelector('.docx-loading');
        const errorEl = previewFallback.querySelector('.docx-error');
        if (loadingEl) loadingEl.classList.remove('hidden');
        if (errorEl) errorEl.classList.add('hidden');
        
        // 更新标题
        const titleEl = previewFallback.querySelector('h4');
        if (titleEl) titleEl.textContent = '正在加载文档...';
        
        // 加载DOCX文件
        const response = await fetch(url);
        if (!response.ok) throw new Error(`无法加载文档: ${response.status}`);
        
        const arrayBuffer = await response.arrayBuffer();
        
        // 使用mammoth.js转换DOCX为HTML
        const result = await mammoth.convertToHtml({ arrayBuffer });
        
        // 将结果显示在预览区域
        docxPreview.innerHTML = result.value;
        
        // 隐藏加载状态，显示DOCX预览
        previewFallback.classList.add('hidden');
        docxPreview.classList.remove('hidden');
        
      } catch (error) {
        console.error('DOCX预览失败:', error);
        
        // 显示错误提示
        const loadingEl = previewFallback.querySelector('.docx-loading');
        const errorEl = previewFallback.querySelector('.docx-error');
        if (loadingEl) loadingEl.classList.add('hidden');
        if (errorEl) errorEl.classList.remove('hidden');
        
        // 更新标题
        const titleEl = previewFallback.querySelector('h4');
        if (titleEl) titleEl.textContent = '文档加载失败';
      }
    }

    function resetPreview() {
      // 重置iframe和预览状态
      if (previewFrame) {
        previewFrame.src = '';
      }
      
      if (previewTitle) {
        previewTitle.textContent = '文章预览';
      }
      
      if (docxPreview) {
        docxPreview.innerHTML = '';
      }
      
      if (previewFallback && previewFrame) {
        // 重置错误和加载状态
        const loadingEl = previewFallback.querySelector('.docx-loading');
        const errorEl = previewFallback.querySelector('.docx-error');
        if (loadingEl) loadingEl.classList.remove('hidden');
        if (errorEl) errorEl.classList.add('hidden');
        
        previewFallback.classList.add('hidden');
        previewFrame.classList.remove('hidden');
      }
    }

  </script>
</body>
</html> 