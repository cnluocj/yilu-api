# 全局设置
{
    email cnluocj@gmail.com # 用于Let's Encrypt通知
}

# 使用指定的域名
sandboxai.jinzhibang.com.cn {
    # 自动启用HTTPS，Caddy会自动申请和管理证书
    
    # 启用压缩
    encode gzip zstd
    
    # 添加安全头
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        Referrer-Policy "strict-origin-when-cross-origin"
    }
    
    # 管理后台路径 - 所有测试页面
    handle /admin/* {
        # 去除路径前缀，将/admin/xxx转发为/xxx
        uri strip_prefix /admin
        
        # 反向代理到yilu-api服务
        reverse_proxy yilu-api:9090 {
            # 健康检查
            health_uri /
            health_interval 30s
            health_timeout 10s
            health_status 200
            
            # 转发请求头
            header_up Host {http.request.host}
            header_up X-Real-IP {http.request.remote}
            header_up X-Forwarded-For {http.request.remote}
            header_up X-Forwarded-Proto {http.request.scheme}
        }
    }
    
    # API路径 - 正常访问API
    handle /api/* {
        # 反向代理到yilu-api服务，不去除前缀
        reverse_proxy yilu-api:9090 {
            # 转发请求头
            header_up Host {http.request.host}
            header_up X-Real-IP {http.request.remote}
            header_up X-Forwarded-For {http.request.remote}
            header_up X-Forwarded-Proto {http.request.scheme}
        }
    }
    
    # 主站内容（原来占用80端口的服务）
    handle {
        reverse_proxy 127.0.0.1:8081
    }
    
    # 日志配置
    log {
        output file /var/log/caddy/access.log
        format json
    }
}

# HTTP 重定向到 HTTPS
:80 {
    redir https://{host}{uri} permanent
}
